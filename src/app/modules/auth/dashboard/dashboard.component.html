<!-- Backdrop for mobile sidebar -->
<div *ngIf="isMobileSidebarOpen" (click)="toggleMobileSidebar()" class="fixed inset-0 bg-black/60 z-40 lg:hidden"
    aria-hidden="true"></div>

<div class="min-h-screen w-full bg-gray-50 flex" *ngIf="user">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 sidebar-bg text-white flex flex-col shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 lg:flex-shrink-0 z-50"
        [class.translate-x-0]="isMobileSidebarOpen">
        
        <!-- Updated Logo and Tagline Section -->
        <div class="p-6 border-b border-white/20 text-center">
            <div class="inline-block bg-white/10 p-4 rounded-3xl">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcROTKn0j9cVpA67LPdjPeYBR3KnWiwP1gsM3cS27rca-7m8BgvgUylY4uhBnOnVnXFx8Is&usqp=CAU"
                    alt="Geminia Logo" class="h-20 w-auto" />
            </div>
            <p class="text-xs italic text-white/70 mt-3 tracking-wide">Think Insurance ... Think Geminia</p>
        </div>

        <div class="p-6 border-b border-white/20">
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <div
                        class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center ring-2 ring-white/30">
                        <span class="text-white font-bold text-lg">{{ getInitials(user.name) }}</span>
                    </div>
                    <div
                        class="absolute -bottom-1 -right-1 w-4 h-4 bg-pantone-light-blue rounded-full border-2 border-pantone-dark-blue">
                    </div>
                </div>
                <div class="flex-1">
                    <p class="text-white/90 text-sm font-medium">Welcome back,</p>
                    <h3 class="font-bold text-white text-lg">{{ user.name.split(' ')[0] }}</h3>
                </div>
            </div>
        </div>

        <nav class="flex-1 p-4 overflow-y-auto">
            <div class="space-y-1">
                <ng-container *ngFor="let item of navigationItems">
                    <a *ngIf="!item.children && item.route" [routerLink]="item.route" routerLinkActive="active-menu-item"
                        class="nav-menu-item group flex items-center space-x-3 px-4 py-3 rounded-xl text-white/80 hover:bg-white/10 hover:text-white transition-all">
                        <mat-icon class="sidebar-nav-icon">{{ item.icon }}</mat-icon><span class="font-medium">{{
                            item.label }}</span>
                        <span *ngIf="item.badge && item.badge > 0"
                            class="ml-auto bg-pantone-dark-blue text-white text-xs px-2 py-1 rounded-full font-bold">{{
                            item.badge }}</span>
                    </a>
                    <div *ngIf="item.children">
                        <button (click)="toggleNavItem(item)"
                            class="nav-menu-item group w-full flex items-center justify-between px-4 py-3 rounded-xl text-white/80 hover:bg-white/10 hover:text-white transition-all">
                            <div class="flex items-center space-x-3">
                                <mat-icon class="sidebar-nav-icon">{{ item.icon }}</mat-icon><span
                                    class="font-medium">{{ item.label }}</span>
                            </div>
                            <mat-icon class="sidebar-nav-icon transition-transform duration-200"
                                [class.rotate-180]="item.isExpanded">expand_more</mat-icon>
                        </button>
                        <div *ngIf="item.isExpanded" class="ml-6 mt-1 space-y-1">
                            <a *ngFor="let child of item.children" [routerLink]="child.route" routerLinkActive="active-submenu-item"
                                class="block w-full text-left px-4 py-2 text-sm text-white/70 hover:text-white hover:bg-white/10 rounded-lg transition-colors">
                                <div class="flex items-center space-x-2">
                                    <mat-icon class="sidebar-nav-icon !text-sm !w-4 !h-4">{{ child.icon }}</mat-icon>
                                    <span>{{ child.label }}</span>
                                </div>
                            </a>
                        </div>
                    </div>
                </ng-container>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-x-hidden">
        <header class="bg-white border-b border-gray-200/50 px-4 py-3 sm:px-6 shadow-sm">
            <div class="flex items-center justify-between gap-4">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button mat-icon-button (click)="toggleMobileSidebar()" class="lg:hidden text-gray-600">
                        <mat-icon>menu</mat-icon>
                    </button>
                    <div>
                        <h1 class="text-xl sm:text-2xl font-bold text-pantone-dark-blue tracking-tight">Dashboard</h1>
                        <p class="text-sm text-gray-600 mt-1">Overview of your insurance portfolio</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button mat-icon-button [matMenuTriggerFor]="notificationMenu"
                        class="relative text-pantone-light-blue">
                        <mat-icon>notifications</mat-icon>
                        <span *ngIf="getUnreadNotificationCount() > 0"
                            class="absolute -top-1 -right-1 w-5 h-5 bg-pantone-dark-blue text-white text-xs rounded-full flex items-center justify-center font-bold">{{
                            getUnreadNotificationCount() }}</span>
                    </button>
                    <button mat-icon-button [matMenuTriggerFor]="userMenu"
                        class="relative bg-pantone-dark-blue text-white rounded-full w-10 h-10">
                        <span class="font-bold text-sm">{{ getInitials(user.name) }}</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="stats-card" *ngFor="let stat of [
                    { title: 'Active Claims', value: dashboardStats.activeClaims, prefix: '' },
                    { title: 'Marine Policies', value: dashboardStats.marinePolicies, prefix: '' }, 
                    { title: 'Travel Policies', value: dashboardStats.travelPolicies, prefix: '' }, 
                    { title: 'Pending Quotes', value: dashboardStats.pendingQuotes, prefix: '' }, 
                    { title: 'Total Premium', value: (dashboardStats.totalPremium | number: '1.0-0'), prefix: 'KES' }
                ]">
                    <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">{{ stat.title }}</h3>
                    <p class="text-3xl font-bold text-pantone-dark-blue">{{ stat.prefix }} {{ stat.value }}</p>
                    <div class="w-12 h-1 bg-pantone-light-blue rounded-full mt-3"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <!-- My Claims Section -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden" *ngIf="claims.length > 0">
                        <div class="px-6 py-4 bg-pantone-dark-blue text-white">
                            <h2 class="text-xl font-bold flex items-center">
                                <mat-icon class="mr-2">assignment_late</mat-icon>My Claims
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div *ngFor="let claim of claims" class="policy-card group border border-gray-200 rounded-xl overflow-hidden">
                                    <div class="flex items-center justify-between p-4 cursor-pointer" (click)="toggleClaimDetails(claim.id)">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-pantone-light-blue/10 rounded-xl flex items-center justify-center">
                                                <mat-icon class="text-pantone-light-blue">assignment_late</mat-icon>
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-pantone-dark-blue text-lg">{{ claim.claimNumber }}</h4>
                                                <p class="text-sm text-gray-600">Policy: {{ claim.policyNumber }}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <div class="claim-status-chip" [ngClass]="getClaimStatusClass(claim.status)">{{ claim.status }}</div>
                                            <mat-icon class="text-gray-400 transition-transform" [class.rotate-180]="expandedClaimId === claim.id">expand_more</mat-icon>
                                        </div>
                                    </div>
                                    <div class="policy-details-collapsible" [class.expanded]="expandedClaimId === claim.id">
                                        <div class="px-6 pb-4 pt-2">
                                            <h4 class="detail-section-title">Claim Details</h4>
                                            <div class="policy-detail-grid">
                                                <div class="detail-item"><span class="detail-label">Date of Loss</span><span class="detail-value">{{ claim.dateOfLoss | date:'mediumDate' }}</span></div>
                                                <div class="detail-item"><span class="detail-label">Type of Loss</span><span class="detail-value">{{ claim.typeOfLoss }}</span></div>
                                                <div class="detail-item"><span class="detail-label">Estimated Loss</span><span class="detail-value">KES {{ claim.estimatedLoss | number:'1.2-2' }}</span></div>
                                                <div class="detail-item"><span class="detail-label">Date Submitted</span><span class="detail-value">{{ claim.submittedDate | date:'mediumDate' }}</span></div>
                                            </div>
                                            <div class="detail-item-full"><span class="detail-label">Description of Incident</span><span class="detail-value">{{ claim.description }}</span></div>
                                            <h4 class="detail-section-title">Submitted Documents</h4>
                                            <div *ngIf="claim.documents.length > 0; else noDocuments" class="space-y-2">
                                                <div *ngFor="let doc of claim.documents" class="flex items-center p-2 bg-gray-100 rounded-md">
                                                    <mat-icon class="text-gray-500 mr-2">description</mat-icon>
                                                    <span class="text-sm text-pantone-dark-blue font-medium">{{ doc.name }}</span>
                                                    <span class="text-xs text-gray-500 ml-auto">({{ doc.size / 1024 | number:'1.0-0' }} KB)</span>
                                                </div>
                                            </div>
                                            <ng-template #noDocuments><p class="text-sm text-gray-500">No documents were submitted with this claim.</p></ng-template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pending Quotes Section -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                        <div class="px-6 py-4 bg-pantone-dark-blue text-white">
                            <h3 class="text-xl font-bold flex items-center">
                                <mat-icon class="mr-2">pending_actions</mat-icon>Saved Quotes
                            </h3>
                        </div>
                        <div class="p-6">
                            <div *ngIf="pendingQuotes.length > 0; else noQuotes" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div *ngFor="let quote of pendingQuotes" class="quote-card group bg-gray-50 p-6 rounded-xl border border-gray-200">
                                    <div class="flex items-center justify-between mb-4">
                                        <span class="px-3 py-1 bg-amber-500 text-white rounded-full text-xs font-semibold uppercase tracking-wide">{{ quote.status }}</span>
                                        <p class="text-xs text-gray-500">Created: {{ quote.createdDate | date: 'shortDate' }}</p>
                                    </div>
                                    <h4 class="font-bold text-pantone-dark-blue text-lg mb-2 truncate" [title]="quote.title">{{ quote.title }}</h4>
                                    <p class="text-gray-600 text-sm mb-4 line-clamp-2" [title]="quote.quoteDetails.descriptionOfGoods">{{ quote.quoteDetails.descriptionOfGoods }}</p>
                                    <div class="flex items-center justify-between mb-6">
                                        <div class="text-2xl font-bold text-pantone-dark-blue">KES {{ quote.premium.totalPayable | number: '1.0-0' }}</div>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button mat-stroked-button color="warn" (click)="deleteQuote(quote.id)" class="flex-1 !border-red-400 !text-red-500 rounded-xl px-4 py-2 text-sm font-semibold">Delete</button>
                                        <button mat-stroked-button [routerLink]="['/sign-up/marine-quote']" [queryParams]="{ editId: quote.id }" class="flex-1 !border-pantone-light-blue !text-pantone-light-blue rounded-xl px-4 py-2 text-sm font-semibold">Edit</button>
                                        <button mat-raised-button (click)="initiatePayment(quote.id)" class="flex-1 bg-pantone-dark-blue text-white rounded-xl px-4 py-2 text-sm font-semibold">Pay Now</button>
                                    </div>
                                </div>
                            </div>
                            <ng-template #noQuotes>
                                <p class="text-center text-gray-500 py-8">You have no saved quotes. Start a new one and it will appear here!</p>
                            </ng-template>
                        </div>
                    </div>

                    <!-- Active Policies Section -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                        <div class="px-6 py-4 bg-pantone-light-blue text-white">
                            <h2 class="text-xl font-bold flex items-center">
                                <mat-icon class="mr-2">shield</mat-icon>Active Policies
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div *ngFor="let policy of activePolicies" class="policy-card group border border-gray-200 rounded-xl overflow-hidden">
                                    <div class="flex items-center justify-between p-4 cursor-pointer" (click)="togglePolicyDetails(policy.id)">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-pantone-light-blue/10 rounded-xl flex items-center justify-center">
                                                <mat-icon class="text-pantone-light-blue">{{ policy.type === 'marine' ? 'directions_boat' : 'flight' }}</mat-icon>
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-pantone-dark-blue text-lg">{{ policy.title }}</h4>
                                                <p class="text-sm text-gray-600">{{ policy.policyNumber }}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-4">
                                           <span *ngIf="policy.hasClaim" class="claim-filed-chip">Claim Filed</span>
                                           <mat-icon class="text-gray-400 transition-transform" [class.rotate-180]="expandedPolicyId === policy.id">expand_more</mat-icon>
                                        </div>
                                    </div>
                                    <div class="policy-details-collapsible" [class.expanded]="expandedPolicyId === policy.id">
                                        <div class="px-6 pb-4 pt-2">
                                            <div *ngIf="policy.type === 'marine' && policy.marineDetails as details">
                                                <h4 class="detail-section-title">Shipment Details</h4>
                                                <div class="policy-detail-grid">
                                                    <div class="detail-item"><span class="detail-label">Mode of Shipment</span><span class="detail-value">{{ details.modeOfShipment | titlecase }}</span></div>
                                                    <div class="detail-item"><span class="detail-label">Trade Type</span><span class="detail-value">{{ details.tradeType | titlecase }}</span></div>
                                                    <div class="detail-item"><span class="detail-label">Vessel Name</span><span class="detail-value">{{ details.vesselName }}</span></div>
                                                    <div class="detail-item"><span class="detail-label">Country of Origin</span><span class="detail-value">{{ details.origin }}</span></div>
                                                    <div class="detail-item"><span class="detail-label">Destination</span><span class="detail-value">{{ details.destination }}</span></div>
                                                    <div class="detail-item"><span class="detail-label">UCR Number</span><span class="detail-value">{{ details.ucrNumber }}</span></div>
                                                    <div class="detail-item"><span class="detail-label">IDF Number</span><span class="detail-value">{{ details.idfNumber }}</span></div>
                                                </div>
                                            </div>
                                            <div class="mt-6 border-t pt-4 flex justify-between items-center">
                                                <button mat-stroked-button (click)="openClaimModal(policy)" class="file-claim-button">
                                                    <mat-icon>assignment_late</mat-icon> File a Claim
                                                </button>
                                                <button mat-raised-button (click)="downloadCertificate(policy.id)" class="bg-pantone-dark-blue text-white rounded-xl px-6 py-2 text-sm font-semibold">Download Certificate</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                        <div class="px-6 py-4 bg-pantone-light-blue text-white"><h3 class="text-lg font-bold">Quick Actions</h3></div>
                        <div class="p-6 space-y-4">
                            <button mat-raised-button [routerLink]="['/sign-up/marine-quote']" class="w-full bg-pantone-dark-blue text-white rounded-xl p-4 text-sm font-semibold">New Marine Quote</button>
                            <button mat-raised-button [routerLink]="['/sign-up/travel-quote']" class="w-full bg-pantone-dark-blue text-white rounded-xl p-4 text-sm font-semibold">New Travel Quote</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                        <div class="px-6 py-4 bg-pantone-dark-blue text-white"><h3 class="text-lg font-bold">Recent Activity</h3></div>
                        <div class="p-6">
                            <div class="space-y-4 max-h-80 overflow-y-auto">
                                <div *ngFor="let activity of recentActivities" class="activity-item group flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" [style.background-color]="activity.iconColor + '20'">
                                        <mat-icon class="!text-base" [style.color]="activity.iconColor">{{ activity.icon }}</mat-icon>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-pantone-dark-blue truncate">{{ activity.title }}</p>
                                        <p class="text-xs text-gray-500 truncate">{{ activity.description }}</p>
                                        <p class="text-xs text-gray-400 mt-1">{{ activity.timestamp | date:'short' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Menus -->
<mat-menu #notificationMenu="matMenu">
    <div class="px-4 py-3 border-b border-gray-100">
        <h3 class="font-semibold text-pantone-dark-blue">Notifications</h3>
    </div>
    <button mat-menu-item *ngFor="let notification of notifications" (click)="markNotificationAsRead(notification)" class="!min-w-[350px] !whitespace-normal px-4 py-3 hover:bg-gray-50">
        <div class="flex items-start space-x-3">
            <div class="w-2 h-2 rounded-full mt-2 flex-shrink-0" [ngClass]="{'bg-pantone-dark-blue': !notification.read, 'bg-gray-300': notification.read}"></div>
            <div class="flex-1 min-w-0">
                <p class="font-semibold text-pantone-dark-blue text-sm">{{ notification.title }}</p>
                <p class="text-sm text-gray-600 break-words">{{ notification.message }}</p>
                <p class="text-xs text-gray-500 mt-1">{{ notification.timestamp | date:'short' }}</p>
            </div>
        </div>
    </button>
</mat-menu>

<mat-menu #userMenu="matMenu">
    <div class="px-4 py-3 border-b border-gray-100">
        <p class="font-semibold text-pantone-dark-blue">{{ user?.name }}</p>
        <p class="text-sm text-gray-500">{{ user?.email }}</p>
    </div>
    <button mat-menu-item (click)="router.navigate(['/profile'])" class="px-4 py-3 hover:bg-gray-50">
        <mat-icon class="mr-3 text-gray-600">person</mat-icon><span>Profile</span>
    </button>
    <button mat-menu-item (click)="logout()" class="px-4 py-3 hover:bg-gray-50">
        <mat-icon class="mr-3 text-gray-600">logout</mat-icon><span>Logout</span>
    </button>
</mat-menu>